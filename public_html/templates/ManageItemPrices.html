<h2>Manage Item Prices</h2>

<p>Update prices for store items. Changes are saved automatically and logged in the activity log.</p>

<div id="loadingMessage">Loading items...</div>

<div id="successMessage" style="display:none;" data-alert class="alert-box success">
    <span id="successText"></span>
</div>

<div id="errorMessage" style="display:none;" data-alert class="alert-box alert">
    <span id="errorText"></span>
</div>

<div id="itemsTable" style="display:none;">
    <table style="width:100%;">
        <thead>
            <tr>
                <th>Item Name</th>
                <th>Item Code</th>
                <th style="width:120px;">Price ($)</th>
                <th style="width:80px;">Active</th>
                <th style="width:100px;">Actions</th>
            </tr>
        </thead>
        <tbody id="itemsTableBody">
        </tbody>
    </table>
</div>

<script type="text/javascript">
var items = [];
var originalItems = {};

$(document).ready(function() {
    loadItems();
});

function loadItems() {
    $('#loadingMessage').show();
    $('#itemsTable').hide();

    $.ajax({
        url: 'api/itemprices_getall.php',
        type: 'POST',
        data: {},
        dataType: 'json',
        success: function(data) {
            $('#loadingMessage').hide();

            if (data.status !== 'Success') {
                showError('Error loading items: ' + (data.message || 'Unknown error'));
                return;
            }

            items = data.items;

            // Store original values
            items.forEach(function(item) {
                originalItems[item.id] = {
                    price: item.price,
                    active: item.active
                };
            });

            renderItemsTable();
            $('#itemsTable').show();
        },
        error: function(xhr, status, error) {
            $('#loadingMessage').html('<div class="alert-box alert">Failed to load items. Please try again.</div>');
            console.error('Load error:', error);
        }
    });
}

function renderItemsTable() {
    var tbody = $('#itemsTableBody');
    tbody.empty();

    // Group by category
    var categories = {};
    items.forEach(function(item) {
        if (!categories[item.item_category]) {
            categories[item.item_category] = [];
        }
        categories[item.item_category].push(item);
    });

    for (var category in categories) {
        // Category header
        tbody.append('<tr style="background:#eee;"><td colspan="5"><strong>' + escapeHtml(category.charAt(0).toUpperCase() + category.slice(1)) + 's</strong></td></tr>');

        categories[category].forEach(function(item) {
            var activeChecked = item.active ? 'checked' : '';

            var row = '<tr id="row_' + item.id + '">' +
                '<td>' + escapeHtml(item.item_name) + '</td>' +
                '<td><code>' + escapeHtml(item.item_code) + '</code></td>' +
                '<td><input type="number" id="price_' + item.id + '" value="' + item.price.toFixed(2) + '" min="0" step="0.01" style="width:100px;" onchange="markModified(' + item.id + ')"></td>' +
                '<td style="text-align:center;"><input type="checkbox" id="active_' + item.id + '" ' + activeChecked + ' onchange="markModified(' + item.id + ')"></td>' +
                '<td><button class="button tiny" id="save_' + item.id + '" onclick="saveItem(' + item.id + ')" disabled>Save</button></td>' +
                '</tr>';

            tbody.append(row);
        });
    }
}

function markModified(itemId) {
    var currentPrice = parseFloat($('#price_' + itemId).val()) || 0;
    var currentActive = $('#active_' + itemId).is(':checked') ? 1 : 0;

    var original = originalItems[itemId];
    var isModified = (currentPrice !== original.price) || (currentActive !== original.active);

    if (isModified) {
        $('#row_' + itemId).css('background-color', '#ffffcc');
        $('#save_' + itemId).prop('disabled', false);
    } else {
        $('#row_' + itemId).css('background-color', '');
        $('#save_' + itemId).prop('disabled', true);
    }

    hideMessages();
}

function saveItem(itemId) {
    var newPrice = parseFloat($('#price_' + itemId).val());
    var newActive = $('#active_' + itemId).is(':checked') ? 1 : 0;

    if (isNaN(newPrice) || newPrice < 0) {
        showError('Invalid price. Please enter a valid number.');
        return;
    }

    $('#save_' + itemId).prop('disabled', true).text('Saving...');

    $.ajax({
        url: 'api/itemprices_update.php',
        type: 'POST',
        data: {
            item_id: itemId,
            price: newPrice,
            active: newActive
        },
        dataType: 'json',
        success: function(data) {
            if (data.status === 'Success') {
                // Update original values
                originalItems[itemId] = {
                    price: newPrice,
                    active: newActive
                };

                $('#row_' + itemId).css('background-color', '#ccffcc');
                setTimeout(function() {
                    $('#row_' + itemId).css('background-color', '');
                }, 2000);

                showSuccess('Item "' + data.item_code + '" updated successfully.');
            } else {
                showError('Error: ' + data.message);
            }

            $('#save_' + itemId).text('Save');
            markModified(itemId);
        },
        error: function(xhr, status, error) {
            showError('Failed to save changes. Please try again.');
            $('#save_' + itemId).text('Save').prop('disabled', false);
            console.error('Save error:', error);
        }
    });
}

function showSuccess(message) {
    $('#successText').text(message);
    $('#successMessage').show();
    $('#errorMessage').hide();

    setTimeout(function() {
        $('#successMessage').fadeOut();
    }, 5000);
}

function showError(message) {
    $('#errorText').text(message);
    $('#errorMessage').show();
    $('#successMessage').hide();
}

function hideMessages() {
    $('#successMessage').hide();
    $('#errorMessage').hide();
}

function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(text));
    return div.innerHTML;
}
</script>
