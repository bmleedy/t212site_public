<style>
  .impersonate-container {
    max-width: 800px;
  }
  .warning-box {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 20px;
  }
  .warning-box h4 {
    color: #856404;
    margin-top: 0;
  }
  .user-select-container {
    background: #f5f5f5;
    padding: 20px;
    border-radius: 5px;
    margin-bottom: 20px;
  }
  .filter-row {
    margin-bottom: 15px;
  }
  .filter-row label {
    display: inline-block;
    width: 120px;
    font-weight: bold;
  }
  #userList {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-top: 15px;
    background: white;
  }
  .user-item {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .user-item:hover {
    background: #e9ecef;
  }
  .user-item:last-child {
    border-bottom: none;
  }
  .user-info {
    flex-grow: 1;
  }
  .user-name {
    font-weight: bold;
    font-size: 1.1em;
  }
  .user-details {
    color: #666;
    font-size: 0.9em;
    margin-top: 3px;
  }
  .btn-impersonate {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
  }
  .btn-impersonate:hover {
    background: #0056b3;
  }
  .user-count {
    margin: 10px 0;
    font-weight: bold;
    color: #666;
  }
  .loading-spinner {
    text-align: center;
    padding: 40px;
    color: #666;
  }
  .error-message {
    color: #dc3545;
    padding: 20px;
    text-align: center;
  }
</style>

<div class="impersonate-container">
  <h2><i class="fi-torso" style="font-size:24px;"></i> User Impersonation</h2>

  <div class="warning-box">
    <h4><i class="fi-alert" style="font-size:18px;"></i> Important Notice</h4>
    <ul style="margin-bottom:0;">
      <li>Impersonation allows you to view and use the site as another user.</li>
      <li><strong>All actions during impersonation are logged</strong> with your admin identity.</li>
      <li>Use this feature responsibly for troubleshooting and user support only.</li>
      <li>Impersonation ends when you click "Exit Impersonation" or close your browser tab.</li>
    </ul>
  </div>

  <div class="user-select-container">
    <h3>Select a User to Impersonate</h3>

    <div class="filter-row">
      <label for="filterName">Search:</label>
      <input type="text" id="filterName" placeholder="Type name to filter..."
             style="width: 300px; padding: 8px;" onkeyup="filterUsers()">
    </div>

    <div class="filter-row">
      <label for="filterType">User Type:</label>
      <select id="filterType" onchange="loadUsers()" style="padding: 8px;">
        <option value="">All Users</option>
        <option value="Scout">Scouts</option>
        <option value="Adult">Adults</option>
      </select>
    </div>

    <div class="user-count" id="userCount">Loading users...</div>

    <div id="userList">
      <div class="loading-spinner">Loading...</div>
    </div>
  </div>
</div>

<script type="text/javascript">
var allUsers = [];

function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  var div = document.createElement('div');
  div.textContent = String(text);
  return div.innerHTML;
}

function loadUsers() {
  var userType = document.getElementById('filterType').value;

  $('#userList').html('<div class="loading-spinner">Loading...</div>');
  $('#userCount').text('Loading users...');

  $.ajax({
    url: "api/getusersforimpersonation.php",
    type: "post",
    data: JSON.stringify({ userType: userType }),
    contentType: 'application/json',
    dataType: 'json',
    error: function(xhr, status, error) {
      $('#userList').html('<div class="error-message">Error loading users. Please try again.</div>');
      $('#userCount').text('Error');
    },
    success: function(data) {
      if (data.status === 'Error') {
        $('#userList').html('<div class="error-message">' + escapeHtml(data.message) + '</div>');
        $('#userCount').text('Error');
        return;
      }
      allUsers = data.users || [];
      displayUsers(allUsers);
    }
  });
}

function displayUsers(users) {
  if (users.length === 0) {
    $('#userList').html('<div class="loading-spinner">No users found.</div>');
    $('#userCount').text('0 users');
    return;
  }

  var html = '';
  users.forEach(function(user) {
    var userName = escapeHtml(user.user_first) + ' ' + escapeHtml(user.user_last);
    html += '<div class="user-item">';
    html += '<div class="user-info">';
    html += '<div class="user-name">' + userName + '</div>';
    html += '<div class="user-details">ID: ' + escapeHtml(user.user_id) + ' | ';
    html += 'Type: ' + escapeHtml(user.user_type) + ' | ';
    html += 'Email: ' + escapeHtml(user.user_email || 'N/A') + '</div>';
    html += '</div>';
    html += '<button class="btn-impersonate" onclick="startImpersonation(' + user.user_id + ', \'' +
            userName.replace(/'/g, "\\'") + '\')">Impersonate</button>';
    html += '</div>';
  });

  $('#userList').html(html);
  $('#userCount').text(users.length + ' user' + (users.length !== 1 ? 's' : ''));
}

function filterUsers() {
  var searchTerm = document.getElementById('filterName').value.toLowerCase().trim();

  if (searchTerm === '') {
    displayUsers(allUsers);
    return;
  }

  var filtered = allUsers.filter(function(user) {
    var fullName = ((user.user_first || '') + ' ' + (user.user_last || '')).toLowerCase();
    var email = (user.user_email || '').toLowerCase();
    return fullName.indexOf(searchTerm) !== -1 || email.indexOf(searchTerm) !== -1;
  });

  displayUsers(filtered);
}

function startImpersonation(userId, userName) {
  if (!confirm('Impersonate ' + userName + '?\n\nYou will see the site as this user. All actions will be logged with your admin identity.')) {
    return;
  }

  $.ajax({
    url: "api/startimpersonation.php",
    type: "post",
    data: JSON.stringify({ target_user_id: userId }),
    contentType: 'application/json',
    dataType: 'json',
    error: function(xhr, status, error) {
      alert('Error starting impersonation. Please try again.');
    },
    success: function(data) {
      if (data.status === 'Success') {
        // Redirect to home page as the impersonated user
        window.location.href = 'index.php';
      } else {
        alert('Error: ' + (data.message || 'Unknown error'));
      }
    }
  });
}

$(document).ready(function() {
  loadUsers();
});
</script>
