<script type="text/javascript">
  /**
   * Escape HTML special characters to prevent XSS attacks
   * @param {string} str - The string to escape
   * @return {string} The escaped string
   */
  function escapeHtml(str) {
    if (str === null || str === undefined) {
      return '';
    }
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }

  var strTable = "";
  var curMB = "";

  function writeCell(strData, strClass, strLink) {
    var escapedData = escapeHtml(strData);
    if (strLink == null) {
      return "<div class='" + strClass + "'>" + escapedData + "</div>";
    } else {
      var escapedLink = escapeHtml(strLink);
      return "<div class='" + strClass + "'><a href='" + escapedLink + "'>" + escapedData + "</a></div>";
    }
  }

  function beginMB(mbName, mbID) {
    var escapedName = escapeHtml(mbName);
    var escapedID = escapeHtml(String(mbID));
    if (curMB !== "") {
      strTable = strTable + "</div>";
    }
    strTable = strTable + '<div class="row"><div class="large-12 columns">' +
      '<a href="#" class="mb-toggle" data-target="div' + escapedID + '"><h5>' + escapedName +
      '</h5></a></div></div><div id="div' + escapedID + '" style="display:none;">';
  }

  function writeRow(element) {
    var mbName = element["mb_name"];
    if (curMB !== mbName) {
      beginMB(mbName, element["mb_id"]);
      curMB = mbName;
    }
    var fullName = element["last"] + ", " + element["first"];
    var userLink = "User.php?id=" + encodeURIComponent(element["id"]);
    var emailLink = "mailto:" + encodeURIComponent(element["email"]) + "?subject=" + encodeURIComponent(mbName) + "%20Merit%20Badge";

    strTable = strTable + writeCell(fullName, "large-6 columns", userLink);
    strTable = strTable + writeCell(element["email"], "large-6 columns", emailLink);
  }

  $(document).ready(function() {
    // Get CSRF token from hidden field
    var csrfToken = $('#csrf_token').val();

    $.ajax({
      url: "api/getMBcounselors.php",
      type: "post",
      contentType: 'application/json',
      dataType: 'json',
      data: JSON.stringify({csrf_token: csrfToken}),
      error: function(XMLHttpRequest, textStatus, errorThrown) {
        console.log(errorThrown);
        console.log(textStatus);
        $('#userdata').html('<p class="error">Failed to load counselor data. Please try again later.</p>');
      },
      success: function(data) {
        strTable = "";
        curMB = "";
        $('#userdata').empty();

        if (data.error) {
          $('#userdata').html('<p class="error">' + escapeHtml(data.error) + '</p>');
          return;
        }

        if (Array.isArray(data)) {
          data.forEach(writeRow);
          $("#userdata").append(strTable + "</div>");
        }
      }
    });

    // Event delegation for toggle functionality - replaces inline onclick handlers
    $(document).on('click', '.mb-toggle', function(e) {
      e.preventDefault();
      var targetId = $(this).data('target');
      $('#' + targetId).toggle();
    });
  });
</script>

<p>To view Merit Badge counselors, click on the Badge you are interested in. If a Merit Badge is not in this list, please check with the Scoutmaster or Assistant Scoutmasters and they will help locate a counselor for you.</p>
<div id='userdata'></div>
