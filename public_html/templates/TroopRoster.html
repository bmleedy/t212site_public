<script src="js/sortable-table.js"></script>
<script type="text/javascript">
  let strTable;
  let curPatrol;    // used to track current patrol for accordion

  function writeCell(strData, strWidth, strLink) {
    if (strLink == null) {
      return "<td style='width:" + strWidth + ";'>" + strData + "</td>";
    } else {
      return "<td style='width:" + strWidth + ";'><a href='" + strLink + "'>" + strData + "</a></td>";
    }
  }

  function writeRow(element, index, array) {
    let strEmail = element["email"];
    let phones = element["phone"];
    let strPhones = "";
    for (let x in phones) {
      strPhones = strPhones + phones[x] + "<br>";
    }

    strTable = strTable + "<tr>";
    strTable = strTable + writeCell(element["first"] + " " + element["last"], "150px", "User.php?id=" + element["id"]);
    strTable = strTable + writeCell(strPhones, "200px");
    strTable = strTable + writeCell(strEmail, "200px", "mailto:" + strEmail);
    strTable = strTable + "</tr>";
  }

  function loadScoutRows(strSort) {
    let fieldData = {
      "sort": strSort
    };
    $.ajax({
      url: "api/getscouts.php",
      type: "post",
      datatype: 'json',
      data: fieldData,
      error: function(data) {
        console.log(data);
      },
      success: function(data) {
        strTable = "";
        $('#userdata').empty();
        strTable = "<table id='scouttable'><thead><tr>";
        strTable = strTable + "<th><a href=javascript:loadTable('lastname')>Name</a></th>";
        strTable = strTable + "<th>Phone</th><th>E-mail</th>";
        strTable = strTable + "</tr></thead>";
        data.forEach(writeRow);
        strTable = strTable + "</table>";
        $("#userdata").append(strTable);
        if (window.initSortableTables) {
          window.initSortableTables();
        }
      }
    });
  }

  $(document).ready(function() {
    loadScoutRows("lastname");
  });

  //////////////////////////////////////////////////////////////////
  // CSV download functions
  //////////////////////////////////////////////////////////////////
  function tableToCSV() {
    // Variable to store the final csv data
    let csv_data = [];

    // Get each row data
    let rows = document.getElementById('scouttable').getElementsByTagName('tr');
    for (let i = 0; i < rows.length; i++) {

      // Get each column data
      let cols = rows[i].querySelectorAll('td,th');

      // Stores each csv row data
      let csvrow = [];
      for (let j = 0; j < cols.length; j++) {

        let element_text = cols[j].innerText;
        element_text = element_text.replace(/,/g, ' '); // remove commas to avoid column breaking
        csvrow.push(element_text.replace(/\n/g, " | "));
      }

      // Combine each column value with comma
      csv_data.push(csvrow.join(","));
    }
    // Combine each row data with new line character
    csv_data = csv_data.join('\n');

    // Call this function to download csv file
    downloadCSVFile(csv_data);
  }

  function downloadCSVFile(csv_data) {
    // Create CSV file object and feed our csv_data into it
    let CSVFile = new Blob([csv_data], { type: "text/csv" });

    // Create temporary link to initiate download process
    let temp_link = document.createElement('a');

    // Download csv file
    temp_link.download = "scouts_table.csv";
    let url = window.URL.createObjectURL(CSVFile);
    temp_link.href = url;

    // This link should not be displayed
    temp_link.style.display = "none";
    document.body.appendChild(temp_link);

    // Automatically click the link to trigger download
    temp_link.click();
    document.body.removeChild(temp_link);
  }
  //////////////////////////////////////////////////////////////////
</script>

<div id='userdata'></div>

<button type="button" onclick="tableToCSV()">
    download CSV
</button>

<!-- Full size image modal -->
<div id="imageModal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;">
  <span style="position:absolute;top:20px;right:40px;font-size:40px;color:white;cursor:pointer;" onclick="closeImageModal()">&times;</span>
  <img id="modalImg" src="" style="max-width:90vw;max-height:90vh;border:4px solid white;box-shadow:0 0 20px #000;" />
</div>

<script type="text/javascript">
  function showFullImage(imgSrc) {
    let modal = document.getElementById('imageModal');
    let modalImg = document.getElementById('modalImg');
    modalImg.src = imgSrc;
    modal.style.display = 'flex';
  }

  function closeImageModal() {
    let modal = document.getElementById('imageModal');
    modal.style.display = 'none';
    document.getElementById('modalImg').src = '';
  }

  // Close modal when clicking outside image
  document.addEventListener('click', function(e) {
    let modal = document.getElementById('imageModal');
    if (modal.style.display === 'flex' && e.target === modal) {
      closeImageModal();
    }
  });
</script>
