<script type="text/javascript">
  var strTable;
  var reg_ids;  // Registration IDs for payment confirmation

  // Escape HTML to prevent XSS (defense-in-depth, data is also escaped server-side)
  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(String(text)));
    return div.innerHTML;
  }

  function writeCell(strData, strWidth, strLink) {
    var safeData = escapeHtml(strData);
    if (strLink == null) {
      return "<td style='width:" + strWidth + ";'>" + safeData + "</td>";
    } else {
      return "<td style='width:" + strWidth + ";'><a href='" + escapeHtml(strLink) + "'>" + safeData + "</a></td>";
    }
  }

  function writeRow(element, index, array) {
    strStart = element['startdate'];
    strStart = strStart.replace(/-/g, "/");
    var startDate = new Date(strStart);

    strTable = strTable + "<tr>";
    strTable = strTable + writeCell(element["username"], "150px");
    strTable = strTable + writeCell(element["eventname"], "150px", "Event.php?id=" + element["eventid"]);
    strTable = strTable + writeCell(startDate.toDateString(), "150px");
    strTable = strTable + writeCell("$" + element["cost"], "75px");
    strTable = strTable + "</tr>";
  }

  function writeDeniedRow(element, index, array) {
    strTable = strTable + "<tr>";
    strTable = strTable + "<td style='width:150px;'>" + escapeHtml(element["username"] || "Unknown") + "</td>";
    strTable = strTable + "<td style='width:150px;'>" + escapeHtml(element["eventname"] || "Unknown Event") + "</td>";
    strTable = strTable + "<td style='width:300px;'>" + escapeHtml(element["reason"]) + "</td>";
    strTable = strTable + "</tr>";
  }

  $(document).ready(function () {
    reg_ids = document.getElementById('reg_ids').value;
    var fieldData = {
      "reg_ids": reg_ids
    };
    $.ajax({
      url: "api/ppupdate2.php",
      type: "post",
      data: fieldData,
      datatype: 'json',
      error: function (XMLHttpRequest, textStatus, errorThrown) {
        console.log(errorThrown);
        console.log(textStatus);
        $('#userdata').empty();
        $("#userdata").append('<div class="alert-box alert" style="margin-bottom: 20px;"><strong>Error:</strong> Unable to process payment update. Please contact a troop administrator.</div>');
      },
      success: function (data) {
        console.log(data);
        strTable = "";
        $('#userdata').empty();

        // Check if there were any denied registrations
        if (data['denied'] && data['denied'].length > 0) {
          // Show warning message for denied registrations
          var deniedMsg = '<div class="alert-box warning" style="margin-bottom: 20px;">';
          deniedMsg += '<strong>Warning:</strong> Some payment updates could not be processed. ';
          deniedMsg += 'Please review the details below and contact a troop administrator if you need assistance.';
          deniedMsg += '</div>';
          $("#userdata").append(deniedMsg);

          // Show denied registrations table
          strTable = "<h4>Payment Updates Not Processed</h4>";
          strTable += "<table><tr><th>Participant</th><th>Event</th><th>Reason</th></tr>";
          data['denied'].forEach(writeDeniedRow);
          strTable += "</table><br/>";
          $("#userdata").append(strTable);
        }

        // Show successful payments if any
        if (data['eventData'] && data['eventData'].length > 0) {
          if (data['status'] === 'Success') {
            $("#userdata").append('<p>Congratulations! You have paid for the following events. Thanks!</p>');
          } else {
            $("#userdata").append('<h4>Successful Payment Updates</h4>');
          }
          strTable = "<table><tr><th>Participant</th><th>Event</th><th>Start</th><th>Cost</th></tr>";
          data['eventData'].forEach(writeRow);
          strTable = strTable + "</table>";
          $("#userdata").append(strTable);
        } else if (!data['denied'] || data['denied'].length === 0) {
          // No successful payments and no denied - show error
          $("#userdata").append('<div class="alert-box alert" style="margin-bottom: 20px;"><strong>Error:</strong> No payment updates were processed. Please contact a troop administrator.</div>');
        }

        // If all registrations were denied (status is Error), show additional help
        if (data['status'] === 'Error') {
          var helpMsg = '<div class="panel" style="margin-top: 20px;">';
          helpMsg += '<p><strong>Need Help?</strong></p>';
          helpMsg += '<p>If you believe this is an error, please contact the troop webmaster at ';
          helpMsg += '<a href="mailto:t212webmaster@gmail.com">t212webmaster@gmail.com</a>.</p>';
          helpMsg += '</div>';
          $("#userdata").append(helpMsg);
        }
      }
    });
  })
</script>

<div class="row"\>
  <div class="large-12 columns">
    <div id="userButtons"></div>
    <div id='userdata'></div>
  </div>
</div>
