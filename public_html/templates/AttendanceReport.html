<script src="js/jquery.js"></script>

<script type="text/javascript">
var user_id;
var canEditAttendance = false; // Whether user can edit attendance (wm/sa only)
var startDate = null; // Start date for attendance report
var endDate = null; // End date for attendance report
var eventDates = []; // Array of dates with events

$(document).ready(function() {
	user_id = document.getElementById('user_id').value;
	canEditAttendance = (document.getElementById('canEditAttendance').value === '1');

	// Display page title and basic structure
	$('#reportContent').append('<h3>Attendance Report</h3>');
	$('#reportContent').append('<p>View attendance records for all scouts across meetings and events.</p>');

	// Add date range selectors
	$('#reportContent').append('<div class="row"><div class="large-6 columns"><label>Start Date:</label><input type="date" id="startDateSelector" /></div><div class="large-6 columns"><label>End Date:</label><input type="date" id="endDateSelector" /></div></div>');

	// Set default date range
	setDefaultDateRange();

	// Add table container
	$('#reportContent').append('<div class="row"><div class="large-12 columns"><div id="attendanceTable"></div></div></div>');

	// Load scouts
	loadScouts();

	console.log("Attendance Report page loaded for user ID: " + user_id);
	console.log("Can edit attendance: " + canEditAttendance);
});

function setDefaultDateRange() {
	// Get current date in Pacific Time Zone
	var now = new Date();
	var pacificTimeString = now.toLocaleString("en-US", { timeZone: "America/Los_Angeles" });
	var pacificDate = new Date(pacificTimeString);

	// Format end date as YYYY-MM-DD (today)
	var endYear = pacificDate.getFullYear();
	var endMonth = String(pacificDate.getMonth() + 1).padStart(2, '0');
	var endDay = String(pacificDate.getDate()).padStart(2, '0');
	endDate = endYear + '-' + endMonth + '-' + endDay;

	// Calculate start date (2 months ago)
	var twoMonthsAgo = new Date(pacificDate);
	twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
	var startYear = twoMonthsAgo.getFullYear();
	var startMonth = String(twoMonthsAgo.getMonth() + 1).padStart(2, '0');
	var startDay = String(twoMonthsAgo.getDate()).padStart(2, '0');
	startDate = startYear + '-' + startMonth + '-' + startDay;

	// Set the date selector values
	$('#startDateSelector').val(startDate);
	$('#endDateSelector').val(endDate);

	console.log("Date range set: " + startDate + " to " + endDate);
}

function loadScouts() {
	console.log("Loading scouts and events...");

	// Show loading message
	$('#attendanceTable').html('<p>Loading attendance data...</p>');

	// Load events first, then scouts
	$.ajax({
		url: "api/getattendanceevents.php",
		type: "post",
		data: {
			start_date: startDate,
			end_date: endDate
		},
		datatype: 'json',
		error: function(errorThrown) {
			console.error("Error loading events:", errorThrown);
			$('#attendanceTable').html('<p class="alert-box alert">Error loading events. Please try again.</p>');
		},
		success: function(eventsData) {
			console.log("Events loaded:", eventsData);

			if (eventsData.status === "Success") {
				eventDates = eventsData.dates || [];
				console.log("Found " + eventDates.length + " event dates");

				// Now load scouts
				loadScoutsWithEvents();
			} else {
				$('#attendanceTable').html('<p class="alert-box alert">Error loading events: ' + (eventsData.message || 'Unknown error') + '</p>');
			}
		}
	});
}

function loadScoutsWithEvents() {
	$.ajax({
		url: "api/getscoutsforattendance.php",
		type: "post",
		datatype: 'json',
		error: function(errorThrown) {
			console.error("Error loading scouts:", errorThrown);
			$('#attendanceTable').html('<p class="alert-box alert">Error loading scouts. Please try again.</p>');
		},
		success: function(data) {
			console.log("Scouts loaded:", data);

			if (data.status === "Success") {
				if (data.scouts && data.scouts.length > 0) {
					buildAttendanceTable(data.scouts);
				} else {
					$('#attendanceTable').html('<p>No scouts found.</p>');
				}
			} else {
				$('#attendanceTable').html('<p class="alert-box alert">Error: ' + (data.message || 'Unknown error') + '</p>');
			}
		}
	});
}

function buildAttendanceTable(scouts) {
	// Build the table with dynamic date columns
	var tableHTML = '<table>';

	// Build header row 1 (dates)
	tableHTML += '<thead><tr><th rowspan="2">Patrol</th><th rowspan="2">Name</th>';
	eventDates.forEach(function(eventDate) {
		// Format date for display (MM/DD)
		var dateParts = eventDate.date.split('-');
		var displayDate = dateParts[1] + '/' + dateParts[2];
		tableHTML += '<th>' + displayDate + '</th>';
	});
	tableHTML += '</tr>';

	// Build header row 2 (event names)
	tableHTML += '<tr>';
	eventDates.forEach(function(eventDate) {
		// Truncate event name to first 15 characters
		var eventName = eventDate.event_name;
		if (eventName.length > 15) {
			eventName = eventName.substring(0, 15);
		}
		tableHTML += '<th>' + eventName + '</th>';
	});
	tableHTML += '</tr></thead>';

	// Build body rows (one per scout)
	tableHTML += '<tbody>';
	scouts.forEach(function(scout) {
		tableHTML += '<tr>';
		tableHTML += '<td>' + scout.patrol + '</td>';
		tableHTML += '<td>' + scout.first + ' ' + scout.last + '</td>';

		// Add empty cells for each date (attendance will be added later)
		eventDates.forEach(function(eventDate) {
			tableHTML += '<td></td>';
		});

		tableHTML += '</tr>';
	});
	tableHTML += '</tbody></table>';

	$('#attendanceTable').html(tableHTML);

	console.log("Displayed " + scouts.length + " scouts with " + eventDates.length + " event dates");
}
</script>

<div class="row">
	<div class="large-12 columns">
		<div id="reportContent"></div>
	</div>
</div>
