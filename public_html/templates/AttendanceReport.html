<script src="js/jquery.js"></script>

<script type="text/javascript">
var user_id;
var canEditAttendance = false; // Whether user can edit attendance (wm/sa only)
var startDate = null; // Start date for attendance report
var endDate = null; // End date for attendance report

$(document).ready(function() {
	user_id = document.getElementById('user_id').value;
	canEditAttendance = (document.getElementById('canEditAttendance').value === '1');

	// Display page title and basic structure
	$('#reportContent').append('<h3>Attendance Report</h3>');
	$('#reportContent').append('<p>View attendance records for all scouts across meetings and events.</p>');

	// Add date range selectors
	$('#reportContent').append('<div class="row"><div class="large-6 columns"><label>Start Date:</label><input type="date" id="startDateSelector" /></div><div class="large-6 columns"><label>End Date:</label><input type="date" id="endDateSelector" /></div></div>');

	// Set default date range
	setDefaultDateRange();

	// Add table container
	$('#reportContent').append('<div class="row"><div class="large-12 columns"><div id="attendanceTable"></div></div></div>');

	// Load scouts
	loadScouts();

	console.log("Attendance Report page loaded for user ID: " + user_id);
	console.log("Can edit attendance: " + canEditAttendance);
});

function setDefaultDateRange() {
	// Get current date in Pacific Time Zone
	var now = new Date();
	var pacificTimeString = now.toLocaleString("en-US", { timeZone: "America/Los_Angeles" });
	var pacificDate = new Date(pacificTimeString);

	// Format end date as YYYY-MM-DD (today)
	var endYear = pacificDate.getFullYear();
	var endMonth = String(pacificDate.getMonth() + 1).padStart(2, '0');
	var endDay = String(pacificDate.getDate()).padStart(2, '0');
	endDate = endYear + '-' + endMonth + '-' + endDay;

	// Calculate start date (2 months ago)
	var twoMonthsAgo = new Date(pacificDate);
	twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
	var startYear = twoMonthsAgo.getFullYear();
	var startMonth = String(twoMonthsAgo.getMonth() + 1).padStart(2, '0');
	var startDay = String(twoMonthsAgo.getDate()).padStart(2, '0');
	startDate = startYear + '-' + startMonth + '-' + startDay;

	// Set the date selector values
	$('#startDateSelector').val(startDate);
	$('#endDateSelector').val(endDate);

	console.log("Date range set: " + startDate + " to " + endDate);
}

function loadScouts() {
	console.log("Loading scouts...");

	// Show loading message
	$('#attendanceTable').html('<p>Loading scouts...</p>');

	$.ajax({
		url: "api/getscoutsforattendance.php",
		type: "post",
		datatype: 'json',
		error: function(errorThrown) {
			console.error("Error loading scouts:", errorThrown);
			$('#attendanceTable').html('<p class="alert-box alert">Error loading scouts. Please try again.</p>');
		},
		success: function(data) {
			console.log("Scouts loaded:", data);

			if (data.status === "Success") {
				if (data.scouts && data.scouts.length > 0) {
					// Build the table
					var tableHTML = '<table>';
					tableHTML += '<thead><tr><th>Patrol</th><th>Name</th></tr></thead>';
					tableHTML += '<tbody>';

					data.scouts.forEach(function(scout) {
						tableHTML += '<tr>';
						tableHTML += '<td>' + scout.patrol + '</td>';
						tableHTML += '<td>' + scout.first + ' ' + scout.last + '</td>';
						tableHTML += '</tr>';
					});

					tableHTML += '</tbody></table>';
					$('#attendanceTable').html(tableHTML);

					console.log("Displayed " + data.scouts.length + " scouts");
				} else {
					$('#attendanceTable').html('<p>No scouts found.</p>');
				}
			} else {
				$('#attendanceTable').html('<p class="alert-box alert">Error: ' + (data.message || 'Unknown error') + '</p>');
			}
		}
	});
}
</script>

<div class="row">
	<div class="large-12 columns">
		<div id="reportContent"></div>
	</div>
</div>
