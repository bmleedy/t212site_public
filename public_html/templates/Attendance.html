<script src="js/jquery.js"></script>

<script type="text/javascript">
var user_id;
var selectedPatrolId = null;
var defaultPatrolId = null;

$(document).ready(function() {
	user_id = document.getElementById('user_id').value;

	// Display page title and basic structure
	$('#attendanceContent').append('<h3>Attendance Tracker</h3>');
	$('#attendanceContent').append('<p>Welcome to the Attendance Tracker. Select a patrol to view and record attendance.</p>');

	// Add patrol selector section
	$('#attendanceContent').append('<div class="row"><div class="large-12 columns"><label>Select Patrol:</label><select id="patrolSelector"><option value="">Loading patrols...</option></select></div></div>');

	// Add members table section (initially hidden)
	$('#attendanceContent').append('<div class="row" id="membersTableContainer" style="display:none;"><div class="large-12 columns"><div id="membersTable"></div></div></div>');

	// Get user's default patrol, then load patrols
	getUserDefaultPatrol();

	console.log("Attendance page loaded for user ID: " + user_id);
});

function getUserDefaultPatrol() {
	$.ajax({
		url: "api/getuserpatrol.php",
		type: "post",
		data: { user_id: user_id },
		datatype: 'json',
		error: function(errorThrown) {
			console.error("Error getting user's default patrol:", errorThrown);
			// Continue loading patrols even if we can't get default
			loadPatrols();
		},
		success: function(data) {
			console.log("User's default patrol:", data);
			if (data.status === "Success" && data.patrol_id) {
				defaultPatrolId = data.patrol_id;
			}
			// Load patrols after we know the default
			loadPatrols();
		}
	});
}

function loadPatrols() {
	$.ajax({
		url: "api/getpatrols.php",
		type: "post",
		datatype: 'json',
		error: function(errorThrown) {
			console.error("Error loading patrols:", errorThrown);
			$('#patrolSelector').html('<option value="">Error loading patrols</option>');
		},
		success: function(data) {
			console.log("Patrols loaded:", data);

			if (data.status === "Success") {
				// Clear the dropdown
				$('#patrolSelector').empty();

				// Add default option
				$('#patrolSelector').append('<option value="">-Select a Patrol-</option>');

				// Add each patrol as an option
				if (data.patrols && data.patrols.length > 0) {
					data.patrols.forEach(function(patrol) {
						var selected = '';
						// Set default selection if this patrol matches the user's default
						if (defaultPatrolId && patrol.id == defaultPatrolId) {
							selected = ' selected';
						}
						$('#patrolSelector').append('<option value="' + patrol.id + '"' + selected + '>' + patrol.label + '</option>');
					});
				}

				// Set up change event handler
				$('#patrolSelector').on('change', function() {
					selectedPatrolId = $(this).val();
					console.log("Patrol selected: " + selectedPatrolId);

					// Load patrol members when patrol is selected
					if (selectedPatrolId && selectedPatrolId !== '0') {
						loadPatrolMembers(selectedPatrolId);
					} else {
						// Hide table if no patrol or "None" selected
						$('#membersTableContainer').hide();
					}
				});

				// If a default patrol was set, automatically load its members
				if (defaultPatrolId) {
					console.log("Auto-loading members for default patrol: " + defaultPatrolId);
					loadPatrolMembers(defaultPatrolId);
				}
			} else {
				$('#patrolSelector').html('<option value="">Error: ' + (data.message || 'Unknown error') + '</option>');
			}
		}
	});
}

function loadPatrolMembers(patrolId) {
	console.log("Loading members for patrol: " + patrolId);

	// Show loading message
	$('#membersTable').html('<p>Loading patrol members...</p>');
	$('#membersTableContainer').show();

	$.ajax({
		url: "api/getpatrolmembers.php",
		type: "post",
		data: { patrol_id: patrolId },
		datatype: 'json',
		error: function(errorThrown) {
			console.error("Error loading patrol members:", errorThrown);
			$('#membersTable').html('<p class="alert-box alert">Error loading patrol members. Please try again.</p>');
		},
		success: function(data) {
			console.log("Patrol members loaded:", data);

			if (data.status === "Success") {
				if (data.members && data.members.length > 0) {
					// Build the table
					var tableHTML = '<h5>Patrol Members</h5>';
					tableHTML += '<table>';
					tableHTML += '<thead><tr><th style="width:80px;">Present</th><th>Name</th></tr></thead>';
					tableHTML += '<tbody>';

					data.members.forEach(function(member) {
						tableHTML += '<tr>';
						tableHTML += '<td><input type="checkbox" class="attendance-checkbox" data-user-id="' + member.user_id + '" /></td>';
						tableHTML += '<td>' + member.first + ' ' + member.last + '</td>';
						tableHTML += '</tr>';
					});

					tableHTML += '</tbody></table>';
					$('#membersTable').html(tableHTML);
				} else {
					$('#membersTable').html('<p>No members found in this patrol.</p>');
				}
			} else {
				$('#membersTable').html('<p class="alert-box alert">Error: ' + (data.message || 'Unknown error') + '</p>');
			}
		}
	});
}
</script>

<div class="row">
	<div class="large-12 columns">
		<div id="attendanceContent"></div>
	</div>
</div>

