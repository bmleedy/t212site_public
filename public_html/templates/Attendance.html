<script src="/js/jquery-3.7.1.min.js"></script>
<script src="/js/jquery-migrate-3.4.1.min.js"></script>
<script src="/js/ajaxsetup-csrf-traditional.js"></script>

<script type="text/javascript">
// XSS prevention helper
function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

var user_id;
var selectedPatrolId = null;
var defaultPatrolId = null;
var selectedDate = null; // Currently selected date for attendance
var canEditPastDates = false; // Whether user can edit dates other than today

$(document).ready(function() {
  user_id = document.getElementById('user_id').value;
  canEditPastDates = (document.getElementById('canEditPastDates').value === '1');

  // Display page title and basic structure
  $('#attendanceContent').append('<h3>Attendance Tracker</h3>');
  $('#attendanceContent').append('<p>Welcome to the Attendance Tracker. Select a patrol to view and record attendance.</p>');

  // Add date selector section
  $('#attendanceContent').append('<div class="row"><div class="large-12 columns"><label>Attendance Date:</label><input type="date" id="dateSelector" /></div></div>');

  // Set date selector to current date in Pacific Time
  setCurrentDate();

  // If user cannot edit past dates, disable the date selector
  if (!canEditPastDates) {
    $('#dateSelector').prop('disabled', true);
    $('#dateSelector').attr('title', 'Patrol leaders can only record attendance for the current date. To update past attendance records, please contact your Scoutmaster or Webmaster.');
  } else {
    // For scoutmasters/webmasters, add change event handler
    $('#dateSelector').on('change', function() {
      selectedDate = $(this).val();
      console.log("Date changed to: " + selectedDate);

      // Reload patrol members for the new date if a patrol is selected
      if (selectedPatrolId && selectedPatrolId !== '0') {
        loadPatrolMembers(selectedPatrolId);
      }
    });
  }

  // Add patrol selector section
  $('#attendanceContent').append('<div class="row"><div class="large-12 columns"><label>Select Patrol:</label><select id="patrolSelector"><option value="">Loading patrols...</option></select></div></div>');

  // Add members table section (initially hidden)
  $('#attendanceContent').append('<div class="row" id="membersTableContainer" style="display:none;"><div class="large-12 columns"><div id="membersTable"></div></div></div>');

  // Get user's default patrol, then load patrols
  getUserDefaultPatrol();

  console.log("Attendance page loaded");
});

function setCurrentDate() {
  // Get current date in Pacific Time Zone
  // JavaScript Date objects use local time, so we need to calculate Pacific Time offset
  var now = new Date();

  // Convert to Pacific Time (UTC-8 or UTC-7 depending on DST)
  // Using toLocaleString to get the date in Pacific timezone
  var pacificTimeString = now.toLocaleString("en-US", { timeZone: "America/Los_Angeles" });
  var pacificDate = new Date(pacificTimeString);

  // Format as YYYY-MM-DD for the date input
  var year = pacificDate.getFullYear();
  var month = String(pacificDate.getMonth() + 1).padStart(2, '0');
  var day = String(pacificDate.getDate()).padStart(2, '0');
  var dateString = year + '-' + month + '-' + day;

  // Set the date selector value
  $('#dateSelector').val(dateString);
  selectedDate = dateString;

  console.log("Current date in Pacific Time: " + dateString);
}

function getUserDefaultPatrol() {
  $.ajax({
    url: "api/getuserpatrol.php",
    type: "post",
    data: { user_id: user_id },
    datatype: 'json',
    error: function(errorThrown) {
      console.error("Error getting user's default patrol:", errorThrown);
      // Continue loading patrols even if we can't get default
      loadPatrols();
    },
    success: function(data) {
      if (data.status === "Success" && data.patrol_id) {
        defaultPatrolId = data.patrol_id;
      }
      // Load patrols after we know the default
      loadPatrols();
    }
  });
}

function loadPatrols() {
  $.ajax({
    url: "api/getpatrols.php",
    type: "post",
    datatype: 'json',
    error: function(errorThrown) {
      console.error("Error loading patrols:", errorThrown);
      $('#patrolSelector').html('<option value="">Error loading patrols</option>');
    },
    success: function(data) {
      if (data.status === "Success") {
        // Clear the dropdown
        $('#patrolSelector').empty();

        // Add default option
        $('#patrolSelector').append('<option value="">-Select a Patrol-</option>');

        // Add each patrol as an option
        if (data.patrols && data.patrols.length > 0) {
          data.patrols.forEach(function(patrol) {
            var selected = '';
            // Set default selection if this patrol matches the user's default
            if (defaultPatrolId && patrol.id == defaultPatrolId) {
              selected = ' selected';
            }
            $('#patrolSelector').append('<option value="' + escapeHtml(patrol.id) + '"' + selected + '>' + escapeHtml(patrol.label) + '</option>');
          });
        }

        // Set up change event handler
        $('#patrolSelector').on('change', function() {
          selectedPatrolId = $(this).val();
          console.log("Patrol selected: " + selectedPatrolId);

          // Load patrol members when patrol is selected
          if (selectedPatrolId && selectedPatrolId !== '0') {
            loadPatrolMembers(selectedPatrolId);
          } else {
            // Hide table if no patrol or "None" selected
            $('#membersTableContainer').hide();
          }
        });

        // If a default patrol was set, automatically load its members
        if (defaultPatrolId) {
          console.log("Auto-loading members for default patrol: " + defaultPatrolId);
          selectedPatrolId = defaultPatrolId; // Set selectedPatrolId so date changes work
          loadPatrolMembers(defaultPatrolId);
        }
      } else {
        $('#patrolSelector').html('<option value="">Error: ' + escapeHtml(data.message || 'Unknown error') + '</option>');
      }
    }
  });
}

function loadPatrolMembers(patrolId) {
  console.log("Loading members for patrol: " + patrolId);

  // Show loading message
  $('#membersTable').html('<p>Loading patrol members...</p>');
  $('#membersTableContainer').show();

  $.ajax({
    url: "api/getpatrolmembers.php",
    type: "post",
    data: {
      patrol_id: patrolId,
      date: selectedDate // Send selected date to get attendance for that specific date
    },
    datatype: 'json',
    error: function(errorThrown) {
      console.error("Error loading patrol members:", errorThrown);
      $('#membersTable').html('<p class="alert-box alert">Error loading patrol members. Please try again.</p>');
    },
    success: function(data) {
      if (data.status === "Success") {
        if (data.members && data.members.length > 0) {
          // Build the table
          var tableHTML = '<h5>Patrol Members</h5>';
          tableHTML += '<table>';
          tableHTML += '<thead><tr><th style="width:80px;text-align:center;" title="Mark the scout present for the selected date - ask your webmaster to make updates for any day that\'s not today.">Present</th><th>Name</th></tr></thead>';
          tableHTML += '<tbody>';

          data.members.forEach(function(member) {
            tableHTML += '<tr>';
            var checked = member.was_present ? ' checked' : '';
            tableHTML += '<td style="text-align:center;"><input type="checkbox" class="attendance-checkbox" data-user-id="' + escapeHtml(member.user_id) + '"' + checked + ' /></td>';
            tableHTML += '<td>' + escapeHtml(member.first) + ' ' + escapeHtml(member.last) + '</td>';
            tableHTML += '</tr>';
          });

          tableHTML += '</tbody></table>';
          $('#membersTable').html(tableHTML);

          // Set up click event handlers for checkboxes
          $('.attendance-checkbox').on('change', function() {
            var checkbox = $(this);
            var userId = checkbox.data('user-id');
            var wasPresent = checkbox.is(':checked');

            // Update attendance via AJAX
            updateAttendance(userId, wasPresent, checkbox);
          });
        } else {
          $('#membersTable').html('<p>No members found in this patrol.</p>');
        }
      } else {
        $('#membersTable').html('<p class="alert-box alert">Error: ' + escapeHtml(data.message || 'Unknown error') + '</p>');
      }
    }
  });
}

function updateAttendance(userId, wasPresent, checkbox) {
  // Disable checkbox while updating
  checkbox.prop('disabled', true);

  $.ajax({
    url: "api/updateattendance.php",
    type: "post",
    data: {
      user_id: userId,
      was_present: wasPresent,
      date: selectedDate // Send selected date for attendance update
    },
    datatype: 'json',
    error: function(errorThrown) {
      console.error("Error updating attendance:", errorThrown);
      alert("Error updating attendance. Please try again.");

      // Re-enable checkbox and revert state on error
      checkbox.prop('disabled', false);
      checkbox.prop('checked', !wasPresent);
    },
    success: function(data) {
      // Re-enable checkbox
      checkbox.prop('disabled', false);

      if (data.status === "Success") {
        // Attendance updated successfully
        // Visual feedback could be added here (e.g., brief highlight)
      } else {
        alert("Error: " + (data.message || 'Failed to update attendance'));
        // Revert checkbox state on error
        checkbox.prop('checked', !wasPresent);
      }
    }
  });
}
</script>

<div class="row">
  <div class="large-12 columns">
    <div id="attendanceContent"></div>
  </div>
</div>

