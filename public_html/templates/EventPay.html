<?php
  $serverName = $_SERVER['SERVER_NAME'];
  $serverPort = $_SERVER['SERVER_PORT'];
  $url = dirname('https://' . $serverName . $_SERVER['REQUEST_URI']);
  $returnUrl = $url . "/PPReturnPage2.php";
  $cancelUrl =  $url . "/EventPay.php";
?>

<!-- PayPal JavaScript SDK with Venmo, Card, and Apple Pay support -->
<script src="https://www.paypal.com/sdk/js?client-id=<?php echo htmlspecialchars($paypal_client_id); ?>&enable-funding=venmo&currency=USD"></script>

<script type="text/javascript">
var objEvents = [];
var payItems=[];
var reg_ids='';
var strTable;
var user_id;

// Initialize PayPal Buttons when DOM is ready
function initPayPalButtons() {
  paypal.Buttons({
    // Style the buttons
    style: {
      layout: 'vertical',
      color: 'gold',
      shape: 'rect',
      label: 'paypal'
    },

    // Called when the button is clicked
    createOrder: function(data, actions) {
      payItems = []; // Reset for each payment
      reg_ids = '';  // Reset for each payment
      var total = 0;
      var pay_cb = $('[type=checkbox]');
      var itemsForOrder = [];

      for (var i = 0; i < pay_cb.length; i++) {
        if (pay_cb[i].checked) {
          if (reg_ids == '') {
            reg_ids = pay_cb[i].id;
          } else {
            reg_ids = reg_ids + ',' + pay_cb[i].id;
          }
          for (var x = 0; x < objEvents.length; x++) {
            if (objEvents[x].sku == pay_cb[i].id) {
              payItems.push(objEvents[x]);
              // Build items array for the new SDK format
              itemsForOrder.push({
                name: objEvents[x].name.substring(0, 127), // PayPal limits to 127 chars
                unit_amount: {
                  currency_code: 'USD',
                  value: objEvents[x].price
                },
                quantity: '1'
              });
              break;
            }
          }
          total = total + Number(pay_cb[i].value);
        }
      }

      // Validate that at least one event is selected
      if (total === 0) {
        alert('Please select at least one event to pay for.');
        return Promise.reject(new Error('No events selected'));
      }

      // Build a description string with event names
      var eventNames = payItems.map(function(item) { return item.description; }).join(', ');
      var userId = user_id || strID;
      var paymentDescription = "Scout Event: " + eventNames.substring(0, 127);

      return actions.order.create({
        purchase_units: [{
          description: paymentDescription,
          amount: {
            currency_code: 'USD',
            value: total.toFixed(2),
            breakdown: {
              item_total: {
                currency_code: 'USD',
                value: total.toFixed(2)
              }
            }
          },
          items: itemsForOrder
        }]
      });
    },

    // Called when the payment is approved
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        // Redirect to the return page with registration IDs
        window.location = "PPReturnPage2.php?reg_ids=" + reg_ids;
      });
    },

    // Called when there's an error
    onError: function(err) {
      console.error('PayPal error:', err);
      alert('There was an error processing your payment. Please try again.');
    },

    // Called when the user cancels
    onCancel: function(data) {
      console.log('Payment cancelled by user');
    }
  }).render('#paypal-button');
}

function writeCell(strData, strWidth, strLink) {
  if (strLink == null) {
    return "<td style='width:" +strWidth+ ";'>" + strData + "</td>" ;
  } else {
    return "<td style='width:" +strWidth+ ";'><a href='"+strLink+"'>" + strData + "</a></td>" ;
  }
}

function writeRowApprove(element, index, array) {
  strStart = element['startdate'];
  strStart = strStart.replace(/-/g, "/");
  var startDate = new Date(strStart);
  strTable = strTable + "<tr>";
  strTable = strTable + writeCell(element["scoutname"], "150px");
  strTable = strTable + writeCell(element["eventname"], "150px", "Event.php?id=" + element["eventid"]);
  strTable = strTable + writeCell(startDate.toDateString(), "150px");
  strTable = strTable + writeCell("$" + element["cost"], "75px");
  strTable = strTable + writeCell("<a onclick=approve('" + element["regid"] + "') class='round tiny button'>Approve</a>", "100px");
  strTable = strTable + "</tr>";
}

function approve(regID) {
  strURL = "Approve.php?id=" + regID;
  location.href = strURL;
}

function writeRow(element, index, array) {
  strStart = element['startdate'];
  strStart = strStart.replace(/-/g,"/");
  var startDate = new Date(strStart);
  objEvents.push( {sku: element['regid'], name: (element["eventname"] + element["scoutname"]), description: element["eventname"], quantity: "1", price: element["cost"], currency: "USD"} );
  strTable = strTable + "<tr>";
  strTable = strTable + writeCell("<input type='checkbox' name='pay_cb' id='" + element['regid'] + "' value='" + element['cost'] + "'>", "50px");
  strTable = strTable + writeCell(element["scoutname"], "150px");
  strTable = strTable + writeCell(element["eventname"], "150px", "Event.php?id=" + element["eventid"]);
  strTable = strTable + writeCell(startDate.toDateString(), "150px" );
  strTable = strTable + writeCell( "$" + element["cost"], "75px" );
  strTable = strTable + "</tr>";
}

$(document).ready(function () {
  strID = document.getElementById('user_id').value;
  var fieldData = {
    "id": strID
  };
  $.ajax({
    url: "api/geteventpay.php",
    type: "post",
    data: fieldData,
    datatype: 'json',
    error: function(errorThrown) {
      console.log(errorThrown);
    },
    success: function (data) {
      console.log(data);
      strTable = "";
      $('#userdata').empty();
      if (data.eventDataApprove == null) {
        $("#userdataApprove").append("<p>You do not have any Events to Approve.</p>");
      } else {
        strTable = "<table><tr><th>Scout</th><th>Event</th><th>Start</th><th>Cost</th><th>Approve</th></tr>";
        data['eventDataApprove'].forEach(writeRowApprove);
        strTable = strTable + "</table>";
        $("#userdataApprove").append(strTable);
      }

      if (data.eventDataPay == null) {
        $("#userdataPay").append("<p>You do not have any Events to Pay for.</p>");
        // Hide PayPal button if no events to pay for
        $("#paypal-button").hide();
      } else {
        $("#userdataPay").append("<p>Please select all events you would like to pay for and click the Pay button.</p>");
        $("#userdataPay").append("<p><em>You can pay with PayPal, Venmo, or Credit/Debit Card.</em></p>");
        strTable = "<table><tr><th></th><th>Scout</th><th>Event</th><th>Start</th><th>Cost</th></tr>";
        data['eventDataPay'].forEach(writeRow);
        strTable = strTable + "</table>";
        $("#userdataPay").append(strTable);
        // Initialize PayPal buttons after data is loaded
        initPayPalButtons();
      }
    }
  });
})
</script>

<input type="hidden" name="reg_ids" id="reg_ids" value="" />
<div class="row">
  <div class="large-12 columns">
    <h4>Events which require your approval</h4>
    <div id='userdataApprove'></div>
    <br /><h4>Events which require payment</h4>
    <div id='userdataPay'></div>
  </div>
</div>
  
<div id="paypal-button"></div>

